#!groovy
// Check properties
properties([disableConcurrentBuilds()])

pipeline {
	agent {
		label 'master'
	}
	parameters {
		string(name: 'number',defaultValue: 'null',description: 'Salon number')

		booleanParam(name: 'domain',defaultValue: true ,description: 'Take the domain name from salon number')

		booleanParam(name: 'inip',defaultValue: true ,description: 'Take the ip address router from salon number')

		booleanParam(name: 'atsip',defaultValue: true ,description: 'Take the ip address ATS from salon number')

		booleanParam(name: 'dc',defaultValue: true ,description: 'Take the ip address DC from salon number')

		booleanParam(name: 'virt',defaultValue: true ,description: 'Take the ip address Proxmox/VMware from salon number')

		string(name: 'city',defaultValue: 'null',description: 'Enter the name of the city')

		string(name: 'street',defaultValue: 'null',description: 'Enter address')

		choice(name: 'port',choices:['222','22'],description: 'Select the port')

		choice(name: 'type',choices:['edge','Devil'],description: 'Select the port')

		choice(name: 'timezone',choices:['Europe/Moscow','Asia/Yekaterinburg','Asia/Omsk'],description: 'Select timezone')

		choice(name: 'virtual',choices:['proxmox','vmware'],description: 'Select virtual server')
	}
        options {
                buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '10'))
                timestamps()
                skipStagesAfterUnstable()
                disableConcurrentBuilds()
        }
	stages {
		stage("Добавление информации в базу") {
			steps {
				script {
					GET_DOMAIN = sh (
						script: 'echo s' + params.number + '.rbt1.ru',
						label: 'Get domain name',
						returnStdout: true
					).trim()
					GET_INIP = sh (
						script: 'echo 10.20.' + params.number + '.1',
						label: 'Get router ip',
						returnStdout: true
					).trim()
					GET_ATS = sh (
						script: 'echo 10.20.' + params.number + '.20',
						label: 'Get ats ip',
						returnStdout: true
					).trim()
					GET_DC = sh (
						script: 'echo 10.20.' + params.number + '.4',
						label: 'Get domain name',
						returnStdout: true
					).trim()
					GET_VIRT = sh (
						script: 'echo 10.20.' + params.number + '.6',
						label: 'Get domain name',
						returnStdout: true
					).trim()
					sh (script: 'mysql -h 192.168.102.2 -u kalinkin -p159753 RBT -Bse "INSERT INTO rbt(Name) VALUES (${number})" -D RBT')
//					sh (script: 'mysql -h 192.168.102.2 -u kalinkin -p159753 RBT -Bse "INSERT INTO rbt VALUES (${number},' + GET_DOMAIN + ',' + GET_INIP + ',null,' + GET_ATS + ',null,null,null,null,null,${city},\"${street}\",null,null,null,' + GET_DC + ',null,null,null,null,' + GET_VIRT + ',${port},${type},null,null,${timezone},null,null,null,null,null,${virtual})" -D RBT')
//					sh (script: 'mysql -h 192.168.102.2 -u kalinkin -p159753 -Bse "USE RBT;INSERT INTO rbt (Name,Domain,In_IP,ATC_IP,Domain_Controller,VMWare,City,Adress,Port,Type,timezone,virtual) VALUES(${number},' + GET_DOMAIN + ',' + GET_INIP + ',' + GET_ATS + ',' + GET_DC + ',' + GET_VIRT + ',${city},\"${street}\",${port},${type},${timezone},${virtual});"')
				}
			}
		}
	}
}
